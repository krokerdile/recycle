# REVIEW DEVELOP

---
## 리뷰 생성

### 설계
1. 클라이언트에서 `question_id`, `content`, `location`, `tag`를 받는다.
2. 토큰의 정보를 통해 얻은 작성자의 정보와 작성일자와 같은 정보들을 조합한다.
3. 조합한 정보를 DB에 저장한다.
4. 저장한 정보를 이벤트로 날려 리뷰 생성 이벤트를 발행한다.
5. 리뷰 생성 이벤트를 review-query 서버에서 받아 리뷰를 생성한다.

### 예외
| 번호 | 처리                     |
|----|------------------------|
| 1 | 토큰에 담긴 유저에 대한 정보가 없을경우 |

### 쿼리
| 번호 | 쿼리                                                                                                                                   |
|----|--------------------------------------------------------------------------------------------------------------------------------------|
| 1 | `review_id`, `question_id`,`content`, `author`, `author_id`, `location`, `tag`, `created_at`, `updated_at` 값을 review 서버에 저장한다.       |
| 2 | `review_id`, `question_id`,`content`, `author`, `author_id`, `location`, `tag`, `created_at`, `updated_at` 값을 review-query 서버에 저장한다. |

---
## 리뷰 임시 저장

### 설계
1. 클라이언트에서 `t_id`와 `question_id`, `content`, `location`, `tag`를 받는다.
2. 토큰의 정보를 통해 얻은 작성자의 정보와 작성일자와 같은 정보들을 조합한다.
3. t_id와 리뷰를 뜻하는 review, 멤버의 이름을 합쳐 key로 설정하여 redis에 저장한다.
    - - ex) `review_authorId_tId`

### 예외
| 번호 | 처리 |
|----|---|
| 1 | 토큰에 담긴 유저에 대한 정보가 없을경우 |

### 쿼리
| 번호 | 쿼리                                                                                                                     |
|----|------------------------------------------------------------------------------------------------------------------------|
| 1 | `t_id`, `question_id`, `content`, `author`, `author_id`, `location`, `tag`, `created_at`, `updated_at` 값을 redis에 저장한다. |

---
## 멤버 기준 리뷰 목록 조회

### 설계
1. 클라이언트에서 받은 토큰의 정보를 통해 작성자의 정보를 얻는다.
2. 작성자의 정보를 통해 DB에서 리뷰 목록을 조회한다.
3. 조회한 리뷰 목록을 클라이언트에게 전달한다.

### 예외
| 번호 | 처리 |
|----|---|
| 1 | 토큰에 담긴 유저에 대한 정보가 없을경우 |

### 쿼리
| 번호 | 쿼리                                                                                                                |
|----|-------------------------------------------------------------------------------------------------------------------|
| 1 | `author_id`를 통해 리뷰 목록을 검색한다. |

---
## 질문 글 기준 리뷰 목록 조회

### 설계
1. 클라이언트에서 받은 `question_id`를 통해 DB에서 리뷰 목록을 조회한다.
2. 조회한 리뷰 목록을 클라이언트에게 전달한다.

### 예외
| 번호 | 처리 |
|----|---|
| 1 | `question_id`에 해당하는 질문 글이 없을 경우 |

### 쿼리
| 번호 | 쿼리                                                                                                                |
|----|-------------------------------------------------------------------------------------------------------------------|
| 1 | `question_id`를 통해 리뷰 목록을 검색한다. |

---
## 질문 글 기준 임시 리뷰 목록, 리뷰 조회

### 설계
1.  클라이언트에서 `t_id`를 받는다.
    - `t_id`가 있다면 임시 리뷰 하나, 없다면 해당 질문 글에 대한 임시 리뷰 목록을 조회하기 위해 분기한다.
2. 토큰의 정보를 통해 얻은 멤버의 정보와 t_id, 질문임을 알기 위한 review를 조합하여 key를 만들어 조회한다.
    - `t_id`가 없을 경우에는 제외하고 키 생성
    - ex) `review_authorid_t_id`, `review_authorid`
3. 조회한 임시 리뷰 목록을 클라이언트에게 전달한다.
    - 만약 정보가 없을 경우 빈 배열을 전달한다.

### 예외
| 번호 | 처리 |
|----|---|
| 1 | 토큰에 담긴 유저에 대한 정보가 없을경우 |

### 쿼리
| 번호 | 쿼리                                                                                                                 |
|----|--------------------------------------------------------------------------------------------------------------------|
| 1  | redis DB에 like 검색을 사용하여 키값( ex) `review_authorId_tId` )을 통해  멤버가 작성한 임시 질문 글 목록을 조회한다.                             |

---
## 멤버가 질문 글에 작성한 리뷰 목록에서 검색

### 설계
1. 클라이언트에서 검색어 `query`와 `page`, `size`를 받는다.
2. 토큰의 정보를 통해 얻은 멤버의 정보와 query를 기준으로 멤버가 작성한 리뷰 목록을 조회한다.
3. 조회한 멤버의 리뷰 목록을 클라이언트에게 전달한다.
    - 만약 정보가 없을 경우 빈 배열을 전달한다.

### 예외
| 번호  | 처리                     |
|-----|------------------------|
| 1   | 토큰에 담긴 유저에 대한 정보가 없을경우 |

### 쿼리
| 번호 | 쿼리                                    |
|----|---------------------------------------|
| 1 | `query` 를 검색어로 내용이 포함 된 멤버의 리뷰를 조회한다. |

---
## 리뷰 수정

### 설계
1. 클라이언트에서 `review_id`, `question_id`, `content`, `location`, `tag`를 받는다.
2. `review_id`를 통해 DB에서 리뷰를 조회한다.
3. 조회한 리뷰의 작성자와 토큰의 정보를 통해 얻은 작성자의 정보를 비교한다.
4. 작성자가 맞다면 리뷰를 수정한다.
5. 수정한 리뷰를 이벤트로 날려 리뷰 수정 이벤트를 발행한다.
6. 리뷰 수정 이벤트를 review-query 서버에서 받아 리뷰를 수정한다.

### 예외
| 번호 | 처리                            |
|----|-------------------------------|
| 1 | `review_id`에 해당하는 리뷰가 없을 경우 |
| 2 | 토큰에 담긴 유저에 대한 정보가 없을 경우       |
| 3 | 작성자가 아닐 경우                     |

### 쿼리
| 번호 | 쿼리                                                                                                                                        |
|----|-------------------------------------------------------------------------------------------------------------------------------------------|
| 1 | `review_id` 를 통해 리뷰를 조회한다.                                                                                                              |
| 1 | `review_id`, `question_id`,`content`, `author`, `author_id`, `location`, `tag`, `created_at`, `updated_at` 값을 review 서버에 수정하여 저장한다.       |
| 2 | `review_id`, `question_id`,`content`, `author`, `author_id`, `location`, `tag`, `created_at`, `updated_at` 값을 review-query 수정하여 서버에 저장한다. |

---
## 리뷰 삭제

### 설계
1. 클라이언트에서 `review_id`를 받는다.
2. `review_id`를 통해 DB에서 리뷰를 조회한다.
3. 조회한 리뷰의 작성자와 토큰의 정보를 통해 얻은 작성자의 정보를 비교한다.
4. 작성자가 맞다면 리뷰를 삭제한다.
5. 삭제한 리뷰를 이벤트로 날려 리뷰 삭제 이벤트를 발행한다.
6. 리뷰 삭제 이벤트를 review-query 서버에서 받아 리뷰를 삭제한다.

### 예외
| 번호 | 처리                            |
|----|-------------------------------|
| 1 | `review_id`에 해당하는 리뷰가 없을 경우 |
| 2 | 토큰에 담긴 유저에 대한 정보가 없을 경우       |
| 3 | 작성자가 아닐 경우                     |

### 쿼리
| 번호 | 쿼리                                          |
|----|---------------------------------------------|
| 1 | `review_id` 를 통해 review 리뷰를 조회한다.       |
| 2 | `review_id` 를 통해 review 서버에서 리뷰를 삭제한다. | 
| 3  | `review_id` 를 통해 review-query 서버에서 리뷰를 삭제한다. |